name: "Generic workflow to deploy to scalingo, given arguments"

on:
  workflow_call:
    inputs:
      environment:
        type: string
        required: true
      tag:
        type: string
        required: true
      region:
        required: false
        type: string
        default: "osc-fr1"
    secrets:
      SCALINGO_API_TOKEN:
        required: true
      DISCORD_WEBHOOK_URL:
        required: true

jobs:
  deploy:
    name: "Deploy to ${{ inputs.environment }}"
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    concurrency:
      group: deploy-to-scalingo-${{ inputs.environment }}
      cancel-in-progress: true
    steps:
      - name: Install scalingo CLI
        run: |
          wget -qO- https://cli-dl.scalingo.com/install.sh | bash
          echo "$HOME/bin" >> $GITHUB_PATH
      - name: Download back artefact
        uses: actions/download-artifact@v3
        with:
          name: back-build-${{ inputs.tag }}
      - name: Download front artefact
        uses: actions/download-artifact@v3
        with:
          name: front-build-${{ inputs.tag }}
      - name: Login to scalingo
        run: scalingo login --api-token ${{ secrets.SCALINGO_API_TOKEN }}
      - name: Deploy back
        run: scalingo --app if-${{ inputs.environment }}-back --region ${{ inputs.region }} deploy back-build.tar.gz ${{ inputs.tag }}
      - name: Deploy front
        run: scalingo --app if-${{ inputs.environment }}-front --region ${{ inputs.region }} deploy front-build.tar.gz ${{ inputs.tag }}

  notify:
    name: Notify deployed
    needs: deploy
    uses: ./.github/workflows/cd-discord-notification.yml
    with:
      environment: ${{ inputs.environment }}
      tag: "v${{ github.run_number }}"
    secrets:
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
